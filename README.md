# Auto-ambient Doom

A hightly customizable (G-/Q-/L-)ZDoom modification which lets you to dispose ambient sounds/actors to the walls.

Гибко настраиваемая модификация для (G-/Q-/L-)ZDoom, позволяющая автоматически располагать звуки или объекты окружения на стены уровней.

- [English](#en-sector)
  - []
- [Русский](#ru-sector)
  - [Описание](#ru-description)
  - [Настройки](#ru-settings)
  - [Файл конфигурации](#ru-config-file)
  - [Благодарности](#ru-credits)




<a name="en-sector"></a>

# English

Must be here...

## Configuration file





---

<a name="ru-sector"></a>

# Русский

<a name="ru-description"></a>

## Описание

 Суть модификации проста. Для акторов (внутриигровых объектов в Doom) звуки добавляются [элементарно](https://zdoom.org/wiki/A_PlaySound). Для полов/потолков также существуют [встроенные механизмы](https://zdoom.org/wiki/SNDSEQ)... А для текстур на стенах — ничего. В смысле, вообще ничего — ни единой попытки на просторах всего Интернета.

 Итак. Auto-ambient Doom — модификация, позволяющая в автоматическом порядке разместить указанные объекты (по умолчанию — звуки окружения вроде жужжания люминесцентных ламп или вентиляции) на текстуры стен.

 **Минимальная версия движка — GZDoom v3.3.0**. Максимальная не регламентирована.

 Совместимость со всеми проверенными мной модификациями не нарушается.

 При запуске игры модификация считывает последний указанный текстовый файл конфигурации ([см.](#ru-config-file)) и обрабатывает его, извлекая настройки. Использует она их при каждой загрузке нового уровня: собственно, проходится по всей карте, создавая на стенах там, где необходимо, объекты окружения.

 Обычно релиз поставляется в двух вариациях: "`AAmbient_vXYZ.pk3`" по умолчанию включает в себя какие-либо объекты и уже настроенный конфигурационный файл, тогда как "`AAmbient_vXYZ_core_only.pk3`" является чистым ядром проекта.

##### Запуск

 Для запуска под Windows Вы можете мышкой перетащить файл на `gzdoom.exe` (`lzdoom.exe`, `qzdoom.exe`). Для запуска из-под командной строки необходимо воспользоваться командой (подставьте скачанную версию Auto-ambient на место шаблона):

`gzdoom.exe -file AAmbient_v*.pk3`

 Для Linux и MacOS запуск производится практически также.
 Отличия от Windows: `gzdoom` или иной движок семьи ZDoom не обязан иметь расширения, но должен иметь бит разрешения запуска; ну и среда называется терминалом, а не командной строкой. Всё.




<a name="ru-settings"></a>

## Настройки

Открываются в меню "Options"→"Auto-ambient control".

#### Пункт "Modification enabled"

 Отвечает за то, загружается ли модификация вообще. Полезна, например, если кто-нибудь включил эту модификацию в свою сборку, а она Вам не нужна.

 Доступные значения: "Yes" ("Да")/"No" ("Нет").

##### Пункты "Show automatic actors"/"Hide automatic actors"

 Вспомогательная функция, пригождающаяся, например, при картостроении. Позволяет отобразить/скрыть все автоматические объекты на уровне, созданные модификацией.

##### Пункт "Show actors at start"

 Также вспомогательная функция для отладки, позволяет сразу после загрузки уровня отобразить все автоматические объекты.

 Доступные значения: "Yes" ("Да")/"No" ("Нет").

#### Пункт "Log level"

 Уровень журналирования действий модификации.

 Доступные значения:
- "Emergency only" ("Только аварийные ситуации"). Записывает только критические нарушения в работе модификации. Использовать не советую, но мало ли, какие ситуации бывают...
- "Main" ("Основной", стоит по умолчанию). Чуть более подробный вывод. Вполне подходит для обычной игры.
- "Detailed" ("Детализированный"). Крайне удобен для отладки во время написания своего файла конфигурации.
- "Debug" ("Режим отладки"). Помимо всего предыдущего также выводит крайне много внутренней информации мода. **Если Вы встретили баг — лучше всего передавать его на рассмотрение вместе с выводом этого уровня журналирования!**

##### Пункт "Not enough sound channels info"

 Выводить ли в начале уровня сообщение о нехватке виртуальных звуковых каналов (если нужно). Вероятнее всего, после оптимизации расположения звука пункт будет убран. Если таковая произойдёт.

 Доступные значения: "On" (в данном случае "Да")/"Off" ("Нет").



---

<a name="ru-config-file"></a>

## Файл конфигурации

Считывается последний конфигурационный lump вида "aambient*", регистр не важен; приоритет пока что отдаётся файлу "aambient.cfg", что, скорее всего, впоследствии будет убрано.

Файл конфигурации пока что советую делать с переносами UNIX/MacOS ("0x0A" или "0x0D"). Ничего фатального не произойдёт, но для переносов DOS/Windows я ещё модификацию не адаптировал.

Однострочный комментарий начинается с символа "#".

Содержимое файла также регистронезависимо (в итоге приводится к строчному виду).

#### Глобальные ключевые слова

Эти кейворды используются вне каких-либо блоков.

"`include <lumppath>`" подключает дополнительный файл по пути `<lumppath>`, если файл не найден — прерывает парсинг с ошибкой.

"`includeoptional <lumppath>`" также подключает дополнительный файл по пути `<lumppath>`, но при его отсутствии дальнейшее распознавание не срывается.

_"`includeprev`" (неотлаженная, используйте на свой страх и риск!)_. Добавляет файл с таким же названием из предыдущего загруженного архива, если он там существует. Если нет — ничего страшного не происходит.

"`mapsdefaulttextures allow|on|deny|off <mapname1> [<mapname2> [...]]`" разрешает (`allow`/`on`) или запрещает (`deny`/`off`) использовать стандартные текстуры для всех карт с указанными названиями `<mapname*>`. При повторной встрече конструкции записывается последнее значение.

"`maphashesdefaulttextures allow|on|deny|off <mapname1> [<mapname2> [...]]`" — аналогично предыдущему, но работает с контрольными суммами карт.

#### Объявление автоматических звуковых авторов

Синтаксис со всеми возможными комбинациями слов:

```
soundactor <soundactor_name>|default {
	sound <alias>
	mode looped
	mode fixed <tics>
	mode random <mintics> <maxtics>
	volume <volume>
	attn <attenuation>
}
```

"`<soundactor_name>`" — название определения для звукового актора, используется в группах.

Ключевое слово "`default`" в заголовке означает, что до следующего переопределения умолчаний параметры `mode`, `volume` и `attn` во всех блоках такого типа изначально будут присвоены указанным здесь значениям.

"`sound <alias>`" определяет, какой звук из `SNDINFO` будет проигрываться.

"`mode looped|fixed <tics>|random <mintics> <maxtics>`" — способ проигрывания звука:
- "`looped`" отвечает за запуск простого зацикленного звука. В начале предусмотрена случайная задержка от нуля до пяти тактов.
- "`fixed <tics>`" проигрывает указанный звук раз в `<tics>` тактов (1/35 секунды). Первый звук проигрывается с задержкой от нуля до `<tics>` тактов.
- "`random <mintics> <maxtics>`" проигрывает указанный звук, после каждого воспроизведения устанавливая новую задержку от `<mintics>` до `<maxtics>`.

"`volume <volume>`" устанавливает громкость звуку; значения должны лежать в пределах `[0.0; 1.0]`. Перемножается с `$volume` в `SNDINFO`.

"`attn <attenuation>`" устанавливает коэффициет затухания звуку при удалении игрока от него (`0.0` — не затухает вовсе, `1.0` — нормальное значение, более единицы — затухает быстрее). Перемножается с одноимённым параметром в `SNDINFO`.

#### Объявление групп

Синтаксис со всеми возможными комбинациями слов:

```
group <group_name>|default {
	mindistance <value>
	loopedsound <alias> [<volume> [<attenuation>]]
	soundactor <soundactor1> [<soundactor2> [...]]
	actor <class1> [<class2> [...]]
}
```

"`<group_name>`" — название определения для групп, используется в текстурах.

Ключевое слово "`default`" в заголовке означает, что до следующего переопределения умолчаний параметр `mindistance` (и только он!) во всех блоках такого типа изначально будет присвоен указанному здесь значению.

"`mindistance`" определяет, насколько близко акторы этой группы могут появиться друг рядом с другом.

"`loopedsound <alias> [<volume> [<attenuation>]]`" объявляет простой звуковой актор со звуком `<alias>`, громкостью `<volume>` (по умолчанию — `1.0`) и коэффициентом затухания `<attenuation>` (по умолчанию также `1.0`).

"`soundactor <soundactor1> [<soundactor2> [...]]`" добавляет в группу ранее созданного(-ых) звукового(-ых) актора(-ов) (см. "Объявление автоматических звуковых авторов"). Если какого-то объявления не встречалось до этого, прерывает парсинг.

"`actor <class1> [<class2> [...]]`" добавляет в группу любые классы акторов наравне со специальными. ~~Имп в стенке — чем не развлечение?~~

#### Объявление параметров соединения групп с текстурами

Синтаксис со всеми возможными комбинациями слов:

```
textureparam <texparam_name>|default {
	start <x> <y>
	offset <x> <y>
	random <x> <y>
	chance <chance>
}
```

"`<texparam_name>`" — название определения для параметров, используется в текстурах.

Ключевое слово "`default`" в заголовке означает, что до следующего переопределения умолчаний все параметры во всех блоках такого типа изначально будут присвоены указанным здесь значениям.

_Далее считается, что координата "0"/"0" — левый-нижний угол текстуры, а сама она располагается в первом квадранте декартовой плоскости (орт — один пиксель). Процент смещения по текстуре задаётся отрицательными значениями, то есть запись "-50.0" — это "50%"._

"`start <x> <y>`" задаёт начальную позицию для спауна. По умолчанию — "`-50 -50`" (центр текстуры).

"`offset <x> <y>`" изменяет то, насколько спаун-позиция смещается по текстуре. По умолчанию — "`-100 -100`" (смещение на 100%/100%).

"`random <x> [<y>]`" добавляет отклонение к точке появления. Если задан только один параметр, то он применяется и для X, и для Y. По умолчанию смещения нет.

"`chance <chance>`" позволяет указать шанс на появление объекта; значения должны лежать в пределах `[0.0; 1.0]`. По умолчанию — "`1.0`", то есть актор появляется всегда. Применяется после всех статических фильтров, но до проверки на слишком малое расстояние до предыдущих объектов.

#### Объявление текстур

Синтаксис со всеми возможными комбинациями слов:

```
texture default|<texture_name1> [<texture_name2> [...]] {
	group <group_name> <texparam_name>
	group <group_name> <x> <y>
	belowdistchance <onsameline> <onotherlines>

	setflag <flagname>
	+f <flagname>
	resetflag <flagname>
	-f <flagname>

	onmaps <mapname1> [<mapname2> [...]]
	onmaphashes <maphash1> [<maphash2> [...]]
}
```

"`<texture_name*>`" — названия текстур, для которых нужно применить этот блок; если их не существует, то парсер прерывает работу. Реализован парсер простого регулярного выражения: каждый символ, который находится внутри квадратных скобок, будет подставлен в свою текстуру. Например, "`GSTFONT[123]`" превратится в три текстуры "`GSTFONT1`", "`GSTFONT2`" и "`GSTFONT3`", а "`TEST[AB][4Y]`" — в "`TESTA4`", "`TESTAY`", "`TESTB4`" и "`TESTBY`".

Ключевое слово "`default`" в заголовке означает, что до следующего переопределения умолчаний параметры `belowdistchance`, флаги текстур, группы, карты и хэш-суммы карт во всех блоках такого типа изначально будет присвоены указанным здесь значениям; притом группы, карты и хэш-суммы карт сначала удаляются, если в них впоследствии было указано хоть что-то.

"`group <group_name> <texparam_name>`" добавляет группу `<group_name>` с параметрами привязки `<texparam_name>`.

"`group <group_name> <x> <y>`" добавляет группу `<group_name>` по смещению `<x> <y>` (см. примечение к "Объявлению параметров соединения групп с текстурами").

"`belowdistchance <onsameline> <onotherlines>`" позволяет чуть более филигранно управлять возможностью создания акторов, даже если проверка расстояния между ними не уложилась в параметр группы `mindistance`. Первый аргумент отвечает за шанс такого появления на этой же линии, второй — за шанс появления на любой другой; оба значения должны находиться в диапазоне `[0.0; 1.0]`. По умолчанию — "`0.0 0.0`" (всё-таки не создавать).

"`setflag <flagname>`" или "`+f <flagname>`" устанавливает флаг текстуры:
- "`handlecommonlines`" отвечает за обработку обычных линий (`action = 0`; установлен по умолчанию);
- "`handleactionlines`" отвечает за обработку линий с действием (`action ≠ 0`; установлен по умолчанию);
- "`samelinedistmultipl`" или "`selfdistmultipl`" меняет смысл первого агрумента для `belowdistchance`. С этим флагом на шанс в основном влияет расстояние до предыдущих объектов (чем ближе — тем меньше вероятность его появления).
- "`otherlinesdistmultipl`" или "`othersdistmultipl`" аналогичным образом меняет смысл второго агрумента для `belowdistchance`.
- "`alllinesdistmultipl`" или "`usedistmultipl`" устанавливает сразу и `samelinedistmultipl`, и `otherlinesdistmultipl`.

"`resetflag <flagname>`" или "`-f <flagname>`" снимает подобный флаг.

"`onmaps <mapname1> [<mapname2> [...]]`" привязывает определение текстуры к названию(-ям) уровня(-ей). Такие привязанные текстуры имеют более высокий приоритет, чем те, что присутствуют на всех уровнях: если найдётся и текстура, привязанная к карте, и глобальная, то вторая будет просто проигнорирована.

"`onmaphashes <maphash1> [<maphash2> [...]]`" — аналогично предыдущему, но для контрольных сумм карт.


### Пример конфигурационного файла




<a name="ru-credits"></a>

## Благодарности

Спасибо:

- Renaul Damek за моральную поддержку;
- YURA_111 за видео.


